
<!DOCTYPE html>
<html>
  <head>
    <title>できる！Djangoでテスト!</title>
    <meta name="description" content="DjangoCongress JP 2018 の発表資料です。ユニットテストを中心に、Djangoにおけるテストの始めかた、ツールの導入/使い方など、発表者が普段実践してる内容をお話いたします。" >
    <script>
      var notesEnabled =false;
      var sections = [];
      var titleNotes = [];
    </script>
    <meta charset='utf-8'>

    <meta property="og:title" content="できる！Djangoでテスト!">
    <meta property="og:description" content="DjangoCongress JP 2018 の発表資料です。ユニットテストを中心に、Djangoにおけるテストの始めかた、ツールの導入/使い方など、発表者が普段実践してる内容をお話いたします。">
    <meta property="og:image" content="https://tell-k.github.io/djangocongressjp2018/_static/img/ogp.png">
    <meta property="og:url" content="https://tell-k.github.io/djangocongressjp2018">
    <meta property="og:site_name" content="github">
    <meta property="og:type" content="article">
    <meta property="article:author" content="https://github.com/tell-k">

    <meta name="twitter:title" content="できる！Djangoでテスト!">
    <meta name="twitter:description" content="DjangoCongress JP 2018 の発表資料です。ユニットテストを中心に、Djangoにおけるテストの始めかた、ツールの導入/使い方など、発表者が普段実践してる内容をお話いたします。">
    <meta name="twitter:image" content="https://tell-k.github.io/djangocongressjp2018/_static/img/ogp.png">
    <meta name="twitter:card" content="summary_large_image"">
    <meta name="twitter:site" content="@github">
    <meta name="twitter:creator" content="@tell_k">

    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/css/notes.css" type="text/css" />
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script>
    </script>
  </head>
  <body style='display: none'>
    
  <div class="section" id="django">
<h1>できる！Djangoでテスト!<a class="headerlink" href="#django" title="Permalink to this headline">¶</a></h1>
<div class="line-block">
<div class="line">tell-k</div>
<div class="line">DjangoCongress JP 2018 (2018.05.19)</div>
</div>
<div class="section" id="id1">
<h2>おまえ誰よ？<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="https://pbs.twimg.com/profile_images/775582814871752704/J1TaucBz_400x400.jpg"><img alt="https://pbs.twimg.com/profile_images/775582814871752704/J1TaucBz_400x400.jpg" src="https://pbs.twimg.com/profile_images/775582814871752704/J1TaucBz_400x400.jpg" style="width: 20%;" /></a>
<ul class="simple">
<li>tell-k</li>
<li>BePROUD.inc</li>
<li>情弱プログラマー</li>
<li><a class="reference external" href="https://twitter.com/tell_k">https://twitter.com/tell_k</a></li>
<li><a class="reference external" href="https://tell-k.github.io/djangocongressjp2018/">https://tell-k.github.io/djangocongressjp2018/</a></li>
</ul>
</div>
<div class="section" id="beproud-python">
<h2>BePROUD - Pythonメインの受託開発<a class="headerlink" href="#beproud-python" title="Permalink to this headline">¶</a></h2>
<div class="figure" id="id66">
<a class="reference internal image-reference" href="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/3ce742cb9bef4e4f925cb7385e494ff4.png"><img alt="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/3ce742cb9bef4e4f925cb7385e494ff4.png" src="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/3ce742cb9bef4e4f925cb7385e494ff4.png" style="width: 70%;" /></a>
<p class="caption"><span class="caption-text"><a class="reference external" href="https://www.beproud.jp/">https://www.beproud.jp/</a></span></p>
</div>
</div>
<div class="section" id="connpass-it">
<h2>connpass - エンジニアをつなぐIT勉強会支援プラットフォーム<a class="headerlink" href="#connpass-it" title="Permalink to this headline">¶</a></h2>
<div class="figure" id="id67">
<a class="reference internal image-reference" href="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/c4f1511638f241daaaac9e29ed3151c1.png"><img alt="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/c4f1511638f241daaaac9e29ed3151c1.png" src="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/c4f1511638f241daaaac9e29ed3151c1.png" style="width: 70%;" /></a>
<p class="caption"><span class="caption-text"><a class="reference external" href="https://connpass.com/">https://connpass.com/</a></span></p>
</div>
</div>
<div class="section" id="pyq-python">
<h2>PyQ - Pythonオンライン学習サービス<a class="headerlink" href="#pyq-python" title="Permalink to this headline">¶</a></h2>
<div class="figure" id="id68">
<a class="reference internal image-reference" href="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/e9121e88c3b64179993a02198a7514f9.png"><img alt="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/e9121e88c3b64179993a02198a7514f9.png" src="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/e9121e88c3b64179993a02198a7514f9.png" style="width: 70%;" /></a>
<p class="caption"><span class="caption-text"><a class="reference external" href="https://pyq.jp/">https://pyq.jp/</a> ★ Djangoを使ったWeb開発も学習できます! ★</span></p>
</div>
</div>
<div class="section" id="id2">
<h2>目的/動機<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Djangoでユニットテスト書く時どうやってるの？と漠然と聞かれることがあった</li>
<li>ユニットテストの書き方、利用してるライブラリ、気にしてる点。ハマりポイント。色々なトピックがあった</li>
<li>それらを一回まとめてみたいなと思った次第です。</li>
</ul>
</div>
<div class="section" id="id3">
<h2>対象<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Djangoをはじめようとしてる人</li>
<li>ユニットテストとかをどうやってるのか知りたい人</li>
<li>ある日、突然「 <strong>いい感じにテスト書いて</strong> 」と丸投げされて困惑してる人</li>
</ul>
</div>
<div class="section" id="id4">
<h2>今日の目標<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h2>
<a class="reference internal image-reference" href="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/40dbf595606e4879961ef4a13e5cea84.png"><img alt="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/40dbf595606e4879961ef4a13e5cea84.png" src="https://dl.dropboxusercontent.com/spa/ghyn87yb4ejn5yy/40dbf595606e4879961ef4a13e5cea84.png" style="width: 60%;" /></a>
</div>
<div class="section" id="id5">
<h2>主な参考文献<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://www.amazon.co.jp/dp/4274217884">テスト駆動開発</a></li>
<li><a class="reference external" href="http://xunitpatterns.com/">xUnit Test Patterns</a></li>
<li><a class="reference external" href="https://www.amazon.co.jp/dp/4048686291">エキスパートPythonプログラミング改訂2版</a></li>
<li><a class="reference external" href="http://docs.pylonsproject.jp/en/latest/community/testing.html">Pylons 単体テストガイドライン</a><ul>
<li><a class="reference external" href="http://pelican.aodag.jp/xiao-guo-de-naunittest-mataha-callfutnomi-mi.html">効果的なunittest - または、callFUTの秘密</a></li>
</ul>
</li>
<li>この辺から用語/トピックをピックアップします。</li>
</ul>
</div>
<div class="section" id="id7">
<h2>前提<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>サンプルコードは全て Python 3.6,  Django 2.0</li>
<li>非機能要件や受け入れテストの等の話はしません。</li>
<li>テスト駆動開発そのものについては話しません</li>
<li>おすすめパッケージも紹介はしますが、なるべく依存パッケージは増やさない方向です</li>
</ul>
</div>
<div class="section" id="id8">
<h2>テストの種類<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>ユニットテスト &lt;- <code class="docutils literal notranslate"><span class="pre">ほとんどこれの話</span></code><ul>
<li>個々の関数やクラスをテストし、出力結果が予想通りであることを確認するテストです。</li>
</ul>
</li>
<li>統合テスト<ul>
<li>いくつかのモジュールを組み合わせて予想通りに動作するか確認するテスト。</li>
</ul>
</li>
<li>機能テスト<ul>
<li>ユーザーから見える範囲での機能を（例えばブラウザを使って）テストします。確実に想定した動作をするかといった内部構造は考慮しません。</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id9">
<h2>ユニットテストに期待すること<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>実装が意図した通りに動くか素早く確認できること。</li>
<li>不安になくリファクタリングを始められるようになること。</li>
<li>テストコード自体が簡単ドキュメントの役割を果たしてくれること。</li>
</ul>
</div>
<div class="section" id="developer-testing">
<h2>Developer Testing<a class="headerlink" href="#developer-testing" title="Permalink to this headline">¶</a></h2>
<div class="figure" id="id69">
<a class="reference internal image-reference" href="http://image.gihyo.co.jp/assets/images/dev/serial/01/tdd/0003/thumb/TH400_tdd03.png"><img alt="http://image.gihyo.co.jp/assets/images/dev/serial/01/tdd/0003/thumb/TH400_tdd03.png" src="http://image.gihyo.co.jp/assets/images/dev/serial/01/tdd/0003/thumb/TH400_tdd03.png" style="width: 70%;" /></a>
<p class="caption"><span class="caption-text">via. <a class="reference external" href="http://gihyo.jp/dev/serial/01/tdd/0003">第3回　「テスト」という言葉について</a></span></p>
</div>
</div>
<div class="section" id="id11">
<h2>目次<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>テスト設置場所</li>
<li>テストケースを書く</li>
<li>テストを実行する</li>
<li>フィクスチャー</li>
<li>モック</li>
<li>コードカバレッジ</li>
<li>雑多なネタ</li>
<li>まとめ</li>
</ul>
</div>
<div class="section" id="id12">
<h2>テスト設置場所<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id13">
<h2>テスト設置場所<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Djagnoアプリの直下に <code class="docutils literal notranslate"><span class="pre">tests</span></code> パッケージを用意</li>
<li>アプリ内のモジュールに対応する、モジュールを作成する</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sample
   ├── __init__.py
   ├── admin.py
   ├── apps.py
   ├── forms.py
   ├── models.py
   ├── utils.py
   ├── urls.py
   ├── views.py
   └── tests
      ├── __init__.py
      ├── test_admin.py
      ├── test_forms.py
      ├── test_models.py
      ├── test_utils.py
      └── test_views.py
</pre></div>
</div>
</div>
<div class="section" id="id14">
<h2>テストケースを書く<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id15">
<h2>単純な関数をテストしたい<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>例えば以下のような関数をテストしたい</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># sample/utils.py ----</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>

<span class="k">def</span> <span class="nf">diff_days</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - from_date から to_date までの日数を返す。</span>
<span class="sd">    - from_date が to_date 以降であれば None を返す。</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">from_date</span> <span class="o">&gt;=</span> <span class="n">to_date</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">to_date</span> <span class="o">-</span> <span class="n">from_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>

<span class="c1"># Usage --</span>
<span class="n">date1</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">date2</span> <span class="o">=</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">diff_days</span><span class="p">(</span><span class="n">date1</span><span class="p">,</span> <span class="n">date2</span><span class="p">))</span> <span class="c1"># =&gt; 5</span>
<span class="k">print</span><span class="p">(</span><span class="n">diff_days</span><span class="p">(</span><span class="n">date2</span><span class="p">,</span> <span class="n">date1</span><span class="p">))</span> <span class="c1"># =&gt; None</span>
</pre></div>
</div>
</div>
<div class="section" id="id16">
<h2>テストケースを書く<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># sample/tests/test_utils.py ----</span>

<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span>

<span class="k">class</span> <span class="nc">TestDiffDays</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_callFUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">spam</span> <span class="kn">import</span> <span class="n">diff_days</span>
        <span class="k">return</span> <span class="n">diff_days</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_from_date_is_before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; from_date が to_date より古い日付 &quot;&quot;&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_from_date_is_after</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; from_date が to_date と同じか新しい日付 &quot;&quot;&quot;</span>
        <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id17">
<h2>Pylons 単体テストガイドライン<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>ここでは以下のルールに沿っています。</li>
<li><a class="reference external" href="http://docs.pylonsproject.jp/en/latest/community/testing.html#id3">ルール: テスト対象のモジュールをテストモジュールのスコープでインポートしない</a></li>
<li><a class="reference external" href="http://docs.pylonsproject.jp/en/latest/community/testing.html#id3">ルール: 各テストケースメソッドは、 1つのことだけをテストする</a></li>
</ul>
</div>
<div class="section" id="id20">
<h2>テスト対象のモジュールをテストモジュールのスコープでインポートしない<a class="headerlink" href="#id20" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>モジュールスコープでインポートエラーになると、他の関係ないテストも実行できなくなる</li>
<li>できる限り他のテストケースに影響を与えないような配慮をする</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># FUT = Function Under the Test = テスト対象の関数</span>
<span class="k">def</span> <span class="nf">_callFUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">spam</span> <span class="kn">import</span> <span class="n">diff_days</span>
    <span class="k">return</span> <span class="n">diff_days</span><span class="p">(</span><span class="n">from_date</span><span class="p">,</span> <span class="n">to_date</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bad --</span>

<span class="kn">from</span> <span class="nn">spam</span> <span class="kn">import</span> <span class="n">diff_days</span>  <span class="c1"># ImportErrorが発生する</span>

<span class="k">class</span> <span class="nc">TestDiffDays</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_from_date_is_before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 〜 省略 〜</span>

<span class="k">class</span> <span class="nc">TestOther</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>  <span class="c1"># &lt;- X 関係ないテストも実行されない</span>
</pre></div>
</div>
</div>
<div class="section" id="id21">
<h2>各テストケースメソッドは、 1つのことだけをテストする<a class="headerlink" href="#id21" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>全部のテストパターンをごちゃまぜにしない。</li>
<li>テストが落ちた時は片方しかテストされない。</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bad --</span>

<span class="k">def</span> <span class="nf">test_all_test_cases</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="c1"># from_date &lt; to_date</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>

    <span class="c1"># from_date &gt;= to_date</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id22">
<h2>同値分割/境界値分析<a class="headerlink" href="#id22" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>何を気にしてテストを書くのか？</strong></li>
<li>同値分割 … テスト結果をグループ化し代表的な条件をピックアップしてテスト</li>
<li>境界値分析 … テスト結果が変わる境目となる条件をテスト<ul>
<li>例えば 日付の範囲、数値の範囲</li>
<li>テストケースが成立するエッジケースをテストする</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id23">
<h2>同値分割/境界値分析<a class="headerlink" href="#id23" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_from_date_is_before</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; from_date が to_date より古い日付 &quot;&quot;&quot;</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>

    <span class="c1"># 1日前だったらという境界値</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">actual</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_from_date_is_after</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; from_date が to_date と同じか新しい日付 &quot;&quot;&quot;</span>

    <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>

    <span class="c1"># 同日だったらという境界値</span>
    <span class="n">actual</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertIsNone</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="assertion-roulette">
<h2>Assertion Roulette<a class="headerlink" href="#assertion-roulette" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>xUnit Patterns の <a class="reference external" href="http://xunitpatterns.com/Test%20Smells.html">テストの不吉な臭い</a> の一つ</li>
<li>1つのテストケースで複数の入力パターンをテストしている</li>
</ul>
<p>このような場合</p>
<ul class="simple">
<li>どのデータが原因でテストが失敗したかわかりにくい</li>
<li>テスト失敗以後のアサーションが行われない</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bad --</span>

<span class="k">def</span> <span class="nf">test_say_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">asserEqual</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="s1">&#39;tell-k&#39;</span><span class="p">),</span>   <span class="s1">&#39;hello tell-k&#39;</span><span class="p">)</span>   <span class="c1"># 1. 失敗</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">asserEqual</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="s1">&#39;hirokiky&#39;</span><span class="p">),</span> <span class="s1">&#39;hello hirokiky&#39;</span><span class="p">)</span> <span class="c1"># 2. 以後のアサーションは無視</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">asserEqual</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="s1">&#39;django&#39;</span><span class="p">),</span>   <span class="s1">&#39;hello django&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">asserEqual</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="s1">&#39;bucho&#39;</span><span class="p">),</span>    <span class="s1">&#39;hello bucho&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">asserEqual</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="s1">&#39;james&#39;</span><span class="p">),</span>    <span class="s1">&#39;hello james&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">asserEqual</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="s1">&#39;nakagami&#39;</span><span class="p">),</span> <span class="s1">&#39;hello nakagami&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">asserEqual</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="s1">&#39;crohaco&#39;</span><span class="p">),</span>  <span class="s1">&#39;hello crohaco&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="parameterized-test">
<h2>Parameterized Test がおすすめ<a class="headerlink" href="#parameterized-test" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>TestCase.subTest … Python3.4 で追加。テストケースにテストケースを作れる</li>
<li>pytest だと <a class="reference external" href="https://docs.pytest.org/en/latest/parametrize.html">pytest.mark.parametrize</a></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Good --</span>

<span class="k">def</span> <span class="nf">test_say_hello</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tell-k&#39;</span><span class="p">,</span> <span class="s1">&#39;james&#39;</span><span class="p">,</span> <span class="s1">&#39;django&#39;</span><span class="p">,</span> <span class="s1">&#39;bucho&#39;</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
       <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">subTest</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">expected</span><span class="o">=</span><span class="s1">&#39;hello </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">name</span><span class="p">):</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">say_hello</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">expected</span><span class="p">)</span>  <span class="c1"># &lt;- テストが失敗しても次のサブテストは実行される</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="https://web.archive.org/web/20160819210805/https://codeiq.jp/magazine/2013/11/1475/">これであなたもテスト駆動開発マスター！？和田卓人さんがテスト駆動開発問題を解答コード使いながら解説します～現在時刻が関わるテストから、テスト容易性設計を学ぶ #tdd</a></li>
</ul>
</div>
<div class="section" id="id25">
<h2>Django に 依存するテストケース<a class="headerlink" href="#id25" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Djagnoに依存するテストは <code class="docutils literal notranslate"><span class="pre">django.test.TestCase</span></code> を利用します</li>
<li>1テストケース実行する度にDBをクリアしてくれます</li>
</ul>
<div class="figure">
<a class="reference internal image-reference" href="https://docs.djangoproject.com/en/2.0/_images/django_unittest_classes_hierarchy.svg"><img alt="https://docs.djangoproject.com/en/2.0/_images/django_unittest_classes_hierarchy.svg" src="https://docs.djangoproject.com/en/2.0/_images/django_unittest_classes_hierarchy.svg" width="70%" /></a>
</div>
</div>
<div class="section" id="django-test-testcase">
<h2>django.test.TestCase<a class="headerlink" href="#django-test-testcase" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>モデルを使うようなところでは必須</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="kn">from</span> <span class="nn">sample.models</span> <span class="kn">import</span> <span class="n">Item</span>

<span class="k">class</span> <span class="nc">TestSample</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_one</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;name1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>

    <span class="c1"># テストケースが終わるとDBの中身はクリア(rollbackされる)</span>
    <span class="k">def</span> <span class="nf">test_two</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;name1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEual</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">Item</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="section" id="id26">
<h2>テストを実行する<a class="headerlink" href="#id26" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>テストを探して実行する = テストランナー</li>
<li>最近は <a class="reference external" href="https://docs.pytest.org/en/latest/">pytest</a> を使う人も多いと思いますが、ここではDjangoの標準のものを使います。</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python manage.py <span class="nb">test</span>

<span class="c1"># テストt用に設定ファイルを用意して</span>
$ python manage.py <span class="nb">test</span> --settings sample.settings_test
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ python  manage.py <span class="nb">test</span>
Creating <span class="nb">test</span> database <span class="k">for</span> <span class="nb">alias</span> <span class="s1">&#39;default&#39;</span>...  <span class="c1"># &lt;- テスト用DB生成</span>
System check identified no issues <span class="o">(</span><span class="m">0</span> silenced<span class="o">)</span>.
.....................................................................
.....................................................................
----------------------------------------------------------------------
Ran <span class="m">279</span> tests in <span class="m">15</span>.139s

OK <span class="o">(</span><span class="nv">skipped</span><span class="o">=</span><span class="m">0</span><span class="o">)</span>
Destroying <span class="nb">test</span> database <span class="k">for</span> <span class="nb">alias</span> <span class="s1">&#39;default&#39;</span>... <span class="c1"># &lt;- テスト用DB破棄</span>
</pre></div>
</div>
</div>
<div class="section" id="id27">
<h2>pytest を 使いたい人に注意点<a class="headerlink" href="#id27" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">XXXTest</span></code> というクラス名はデフォルトでは探してくれない</li>
<li><code class="docutils literal notranslate"><span class="pre">TestXXX</span></code> という風に <code class="docutils literal notranslate"><span class="pre">Test</span></code> プレフィックスが必要<ul>
<li><a class="reference external" href="https://stackoverflow.com/a/20277099">https://stackoverflow.com/a/20277099</a></li>
<li><a class="reference external" href="http://pytest.readthedocs.io/en/latest/goodpractices.html#conventions-for-python-test-discovery">http://pytest.readthedocs.io/en/latest/goodpractices.html#conventions-for-python-test-discovery</a></li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">unittest.TestCase</span></code> (≒ <code class="docutils literal notranslate"><span class="pre">django.test.TestCase</span></code> ) と組み合わせると一部使えない機能がある<ul>
<li><a class="reference external" href="https://docs.pytest.org/en/latest/unittest.html#pytest-features-in-unittest-testcase-subclasses">https://docs.pytest.org/en/latest/unittest.html#pytest-features-in-unittest-testcase-subclasses</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id28">
<h2>どこまでユニットテストの対象にすべきか?<a class="headerlink" href="#id28" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>自分たちが書いたコードに対してテストを書く。</li>
<li>Djangoやサードパーティのライブラリのテストしない。</li>
<li>テスト対象が依存してる処理/コンポーネントは対象としない<ul>
<li>個別にユニットテストする。</li>
<li>依存部分はモック(後述)などで置き換える。</li>
</ul>
</li>
<li>デバッグ目的のコードは意図的にテストしないこともある<ul>
<li><code class="docutils literal notranslate"><span class="pre">__repr__</span></code> とかね</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id29">
<h2>フィクスチャー<a class="headerlink" href="#id29" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id30">
<h2>フィクスチャー<a class="headerlink" href="#id30" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>テストに必要な状態や条件を用意した環境やデータのこと</li>
<li>TestCase では <code class="docutils literal notranslate"><span class="pre">setUp</span></code>, <code class="docutils literal notranslate"><span class="pre">tearDown</span></code> で用意できる</li>
<li>メソッド群<ul>
<li><code class="docutils literal notranslate"><span class="pre">setUp</span></code>         … メソッド単位の前処理</li>
<li><code class="docutils literal notranslate"><span class="pre">tearDown</span></code>      … メソッド単位の後処理</li>
<li><code class="docutils literal notranslate"><span class="pre">setUpClass</span></code>    … クラス単位の前処理</li>
<li><code class="docutils literal notranslate"><span class="pre">tearDownClass</span></code> … クラス単位の後処理</li>
</ul>
</li>
<li><a class="reference external" href="https://qiita.com/podhmo/items/e941371cbe2b11f5951f">djangoでDBを使ったテストを書く時、setUpTestData()を使うと早く出来る場合がある</a></li>
</ul>
</div>
<div class="section" id="id31">
<h2>フィクスチャー<a class="headerlink" href="#id31" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">TestDoSomething</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_callFUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">sample.api</span> <span class="kn">import</span> <span class="n">compose_data</span>
        <span class="k">return</span> <span class="n">do_something</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setUp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># フィクスチャーの生成</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">good_data</span> <span class="o">=</span> <span class="n">make_fixture_data</span><span class="p">(</span><span class="n">good</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad_data</span> <span class="o">=</span> <span class="n">make_fixture_data</span><span class="p">(</span><span class="n">bad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tearDown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># フィクスチャーの破棄</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">good_data</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad_data</span>

    <span class="k">def</span> <span class="nf">test_do_something_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">good_data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_do_something_ng</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bad_data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="id32">
<h2>なるべくセットアップを共有しない<a class="headerlink" href="#id32" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://docs.pylonsproject.jp/en/latest/community/testing.html#self">ガイドライン: self の属性によってではなく、ヘルパーメソッドによってセットアップを共有する</a></li>
<li>あるテストケースでは必要でも、他のテストケースでは必要ない</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>無駄に生成している</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>テストケース毎にカスタマイズしづらい</li>
<li>無駄なフィクスチャー生成が省ければ、テストの実行も早くなる</li>
</ul>
</div>
<div class="section" id="id33">
<h2>なるべくセットアップを共有しない<a class="headerlink" href="#id33" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Good --</span>

<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">TestDoSomething</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_callFUT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">sample.api</span> <span class="kn">import</span> <span class="n">compose_data</span>
        <span class="k">return</span> <span class="n">do_something</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_do_something_ok</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">good_data</span> <span class="o">=</span> <span class="n">make_fixture_data</span><span class="p">(</span><span class="n">good</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">good_data</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">test_do_something_ng</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bad_data</span> <span class="o">=</span> <span class="n">make_fixture_data</span><span class="p">(</span><span class="n">bad</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">bad_dataa</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="id34">
<h2>Djangoモデルのフィクスチャー<a class="headerlink" href="#id34" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>TestCase に json/yaml からモデルオブジェクトを生成する機能がある</li>
<li><a class="reference external" href="https://docs.djangoproject.com/en/2.0/howto/initial-data/#providing-data-with-fixtures">Providing data with fixtures</a></li>
</ul>
<p>だけど..</p>
<ul class="simple">
<li>1レコード単位のデータをファイルで管理するの大変</li>
<li>クラス単位でしか設定できない -&gt; テストケースごとに変更が難しい</li>
<li>あまりおすすめできない。</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>
<span class="kn">from</span> <span class="nn">myapp.models</span> <span class="kn">import</span> <span class="n">Animal</span>

<span class="k">class</span> <span class="nc">AnimalTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>
   <span class="n">fixtures</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;animals.json&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="factory-boy">
<h2>factory_boy<a class="headerlink" href="#factory-boy" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://factoryboy.readthedocs.io/en/latest/">http://factoryboy.readthedocs.io/en/latest/</a></li>
<li>Djangoモデルのをいい感じに用意してくれる</li>
<li>Django以外にもSQLAlchemy、MongoEngineなど対応してくれる</li>
<li>同種のものに  <a class="reference external" href="http://model-mommy.readthedocs.io/en/latest/index.html">model_mommy</a> がある</li>
</ul>
</div>
<div class="section" id="id35">
<h2>factory_boy<a class="headerlink" href="#id35" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># sample/tests/factories.py</span>
<span class="kn">import</span> <span class="nn">factory</span>

<span class="kn">from</span> <span class="nn">account.tests.factories</span> <span class="kn">import</span> <span class="n">UserFactory</span>

<span class="k">class</span> <span class="nc">ItemFactory</span><span class="p">(</span><span class="n">factory</span><span class="o">.</span><span class="n">django</span><span class="o">.</span><span class="n">DjangoModelFactory</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="s1">&#39;name{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">Sequence</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="s1">&#39;hoge{}@example.com&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
    <span class="n">price</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">owner</span> <span class="o">=</span> <span class="n">factory</span><span class="o">.</span><span class="n">SubFactory</span><span class="p">(</span><span class="n">UserFactory</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;sample.Item&quot;</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">item</span> <span class="o">=</span> <span class="n">ItemFactory</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="c1"># =&gt; name0</span>
<span class="k">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">user</span><span class="p">)</span> <span class="c1"># =&gt; User object</span>

<span class="c1"># フィールドの値も指定できる</span>
<span class="n">ItemFactory</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;newitem&#39;</span><span class="p">)</span>

<span class="c1"># 一気に複数オブジェクトを生成することもできる</span>
<span class="n">ItemFactory</span><span class="o">.</span><span class="n">create_batch</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="factroy-boy">
<h2>factroy_boy のハマりポイント<a class="headerlink" href="#factroy-boy" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>デフォルト値に依存したテストを書いてしまう</li>
<li><strong>誰かが知らずにデフォルト値を変更するとテストが失敗する</strong></li>
<li>Fragile Test(Fragile Fixture) … <a class="reference external" href="http://xunitpatterns.com/Test%20Smells.html">テストの不吉な臭い</a><ul>
<li>フィクスチャの準備をするコードを修正したら、無関係なテストが失敗する</li>
</ul>
</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># テスト対象</span>

<span class="k">def</span> <span class="nf">get_display_price</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;{}円&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Bad --</span>

<span class="k">def</span> <span class="nf">test_display_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">ItemFactory</span><span class="p">()</span>  <span class="c1"># &lt;- ItemFactory.price 100から変更されたらテスト失敗</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;100円&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="id37">
<h2>factroy_boy のハマりポイント<a class="headerlink" href="#id37" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>テストケース内で必要なフィクスチャは、テストケース内で生成する</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Good --</span>

<span class="k">def</span> <span class="nf">test_display_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">ItemFactory</span><span class="p">(</span><span class="n">price</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span> <span class="c1"># &lt;- 100固定</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;100円&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li>デフォルト値に依存しないテストにする</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Good --</span>

<span class="k">def</span> <span class="nf">test_display_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">ItemFactory</span><span class="p">()</span>
    <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;{}円&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>  <span class="c1"># &lt;- item.price を使って期待値を生成</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="id38">
<h2>モック<a class="headerlink" href="#id38" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id39">
<h2>モック<a class="headerlink" href="#id39" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>テスト対象が依存してる処理/コンポーネントを置き換える</li>
<li>例えば、以下のようなものを置き換える<ul>
<li>構築の準備に手間がかかるオブジェクト</li>
<li>実際にネットワーク通信が必要になる処理 =&gt; 外部APIとの通信</li>
<li>テスト実行時に変化する値、日付</li>
</ul>
</li>
<li>xUnit Test Patterns では <strong>Test Double</strong> として分類/整理されている</li>
<li><a class="reference external" href="http://goyoki.hatenablog.com/entry/20120301/1330608789">xUnit Test PatternsのTest Doubleパターン(Mock、Stub、Fake、Dummy等の定義)</a></li>
</ul>
</div>
<div class="section" id="test-double">
<h2>Test Double<a class="headerlink" href="#test-double" title="Permalink to this headline">¶</a></h2>
<div class="figure">
<a class="reference internal image-reference" href="http://xunitpatterns.com/Types%20Of%20Test%20Doubles.gif"><img alt="http://xunitpatterns.com/Types%20Of%20Test%20Doubles.gif" src="http://xunitpatterns.com/Types%20Of%20Test%20Doubles.gif" style="width: 80%;" /></a>
</div>
</div>
<div class="section" id="id40">
<h2>Test Double<a class="headerlink" href="#id40" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>間接入力</strong> … テストコードから見えないテスト対象への入力</li>
<li><strong>間接出力</strong> … テストコードから見えないテスト対象の出力</li>
</ul>
<hr class="docutils" />
<ul class="simple">
<li><strong>Dummy Object</strong> … テストに影響を与えない代替オブジェクトです。</li>
<li><strong>Test Stub</strong>    … 間接入力値をテスト対象に返す</li>
<li><strong>Test Spy</strong>     … 間接出力値を記録/参照可能にする</li>
<li><strong>Mock Object</strong>  … 間接出力を記録/検証可能にする</li>
<li><strong>Fake Object</strong>  … 実際のオブジェクトに近い処理をするが、簡易な実装となっている</li>
</ul>
<hr class="docutils" />
<ul class="simple">
<li>モック(=Test Dobule) の意として話ます。</li>
</ul>
</div>
<div class="section" id="unittest-mock">
<h2>unittest.mock<a class="headerlink" href="#unittest-mock" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Python3.3 から <a class="reference external" href="https://docs.python.org/ja/3.6/library/unittest.mock.html">unittest.mock</a> が追加</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># sample/api.py ---</span>
<span class="kn">from</span> <span class="nn">item.api</span> <span class="kn">import</span> <span class="n">calc_tax_included_price</span>

<span class="c1"># テスト対象</span>
<span class="k">def</span> <span class="nf">get_display_price</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
    <span class="n">price</span> <span class="o">=</span> <span class="n">calc_tax_included_price</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>  <span class="c1"># &lt;- これをモック(Test Stub)に置き換える</span>
    <span class="k">return</span> <span class="s2">&quot;{}円&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">price</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">test_display_price</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">ItemFactory</span><span class="p">()</span>

    <span class="c1"># patch を通して 108 という間接入力値 をテスト対象(get_display_price) に渡してる</span>
    <span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;sample.api.calc_tax_included_price&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="mi">108</span><span class="p">)</span> <span class="k">as</span> <span class="n">m</span><span class="p">:</span>
         <span class="n">expected</span> <span class="o">=</span> <span class="s1">&#39;108円&#39;</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callFUT</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>  <span class="c1"># =&gt; OK</span>

         <span class="c1"># calc_tax_included_price に item引数が渡ったかチェック</span>
         <span class="n">m</span><span class="o">.</span><span class="n">assert_called_with</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="mock-patch">
<h2>mock.patch の ハマりポイント<a class="headerlink" href="#mock-patch" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>mock.patchがうまく当たらないケースがある</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># egg.py  ---</span>
<span class="kn">import</span> <span class="nn">spam</span>

<span class="k">def</span> <span class="nf">say_egg</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">spam</span><span class="o">.</span><span class="n">say_spam</span><span class="p">()</span> <span class="c1"># &lt;- patch対象</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">unittest</span> <span class="kn">import</span> <span class="n">mock</span>
<span class="kn">from</span> <span class="nn">egg</span> <span class="kn">import</span> <span class="n">say_egg</span>

<span class="k">with</span> <span class="n">mock</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="s1">&#39;spam.say_spam&#39;</span><span class="p">,</span> <span class="n">return_value</span><span class="o">=</span><span class="s2">&quot;Patched!&quot;</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="n">say_egg</span><span class="p">())</span> <span class="c1"># =&gt; Patched!</span>
</pre></div>
</div>
<ul class="simple">
<li>何の問題もなくパッチできている</li>
</ul>
</div>
<div class="section" id="id42">
<h2>mock.patch の ハマりポイント<a class="headerlink" href="#id42" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>下記のように書き換えると <strong>patchが失敗する</strong></li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span># egg.py  ---
<span class="gd">- import spam</span>
<span class="gi">+ from spam import say_spam</span>

def echo():
<span class="gd">-   return spam.say_spam()</span>
<span class="gi">+   return say_spam()</span>
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">from</span> <span class="pre">import</span></code> で importされたものは、元のモジュールから切り離される</li>
<li>テスト対象( <code class="docutils literal notranslate"><span class="pre">say_egg</span></code> ) が利用してるものに <code class="docutils literal notranslate"><span class="pre">patch</span></code> をあてる。</li>
</ul>
<div class="highlight-diff notranslate"><div class="highlight"><pre><span></span># Good

<span class="gd">- with mock.patch(&#39;spam.say_spam&#39;, return_value=&quot;Patched!&quot;):</span>
<span class="gi">+ with mock.patch(&#39;egg.say_spam&#39;, return_value=&quot;Patched!&quot;):</span>
     print(say_egg()) # =&gt; Patched!
</pre></div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">patch</span></code> の影響下を局所化する意味でも import されてるところで patchする方が良いです。</li>
</ul>
</div>
<div class="section" id="id43">
<h2>モック その他<a class="headerlink" href="#id43" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>詳しいmockの使いかた</li>
</ul>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://note.crohaco.net/2015/python-mock/">まだmockで消耗してるの？mockを理解するための3つのポイント</a></li>
</ul>
</div></blockquote>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">datetime.now</span></code> はpatchできない</li>
</ul>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://blog.amedama.jp/entry/2016/12/06/220000">Python: freezegun で時刻のテストを楽に書く</a></li>
<li><a class="reference external" href="https://testfixtures.readthedocs.io/en/latest/datetime.html">testfixtures - Mocking dates and times</a></li>
</ul>
</div></blockquote>
<ul class="simple">
<li>HTTPリクエスト(<code class="docutils literal notranslate"><span class="pre">requests</span></code> )をモックしたい<ul>
<li><a class="reference external" href="https://pypi.org/project/responses/">Responses</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id44">
<h2>モック その他<a class="headerlink" href="#id44" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Redisをモックしたい<ul>
<li><a class="reference external" href="https://pypi.org/project/fakeredis/">FakeRedis</a></li>
</ul>
</li>
<li>mock.patch を同時に複数あてたい<ul>
<li><a class="reference external" href="https://docs.python.jp/3/library/contextlib.html#contextlib.ExitStack">contextlib.ExitStack</a></li>
<li><a class="reference external" href="https://atsuoishimoto.hatenablog.com/entry/2013/01/25/000000">Python 3.3 からの with 文</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id45">
<h2>可能な限り簡潔に<a class="headerlink" href="#id45" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="http://docs.pylonsproject.jp/en/latest/community/testing.html#fixture">ガイドライン: fixture を可能な限り単純にしてください</a></li>
<li>フィクスチャーやモックは可能限り簡潔にするのが良い</li>
<li>モックを使いすぎて逆に混乱する</li>
<li>モック使いすぎ = <strong>設計見直し/リファクタリングのチャンス</strong></li>
</ul>
</div>
<div class="section" id="id46">
<h2>コードカバレッジ<a class="headerlink" href="#id46" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="id47">
<h2>コードカバレッジ<a class="headerlink" href="#id47" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>テストコードがテスト対象を、どれくらいパスしているか計測したもの</li>
<li>これを計測しながらユニットテストを書いていくのが個人的におすすめです。</li>
<li>見るべきポイント</li>
</ul>
<blockquote>
<div><ul class="simple">
<li>テストが意図した通りにパスしてるか</li>
<li>テストが書かれてない場所がないか確認</li>
<li>不要なコードをないか(使われてない, 到達不能なコード)</li>
</ul>
</div></blockquote>
</div>
<div class="section" id="id48">
<h2>コードカバレッジの分類<a class="headerlink" href="#id48" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>C0: 命令網羅(statement coverage)<ul>
<li>全ての命令を一度は実行する</li>
</ul>
</li>
<li>C1: 分岐網羅(branch coverage)<ul>
<li>全ての分岐条件をパスする</li>
</ul>
</li>
<li>C2: 条件網羅(condition coverage)<ul>
<li>全ての条件をパスする</li>
</ul>
</li>
<li>C0/C1 くらいまでならカバレッジツールが計測できる</li>
</ul>
</div>
<div class="section" id="id49">
<h2>カバレッジの計測ツール<a class="headerlink" href="#id49" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://pypi.org/project/coverage/">coverage</a> パッケージを利用</li>
<li>pytest であれば <a class="reference external" href="https://pypi.org/project/pytest-cov/">pytest-cov</a> とかで使える</li>
</ul>
</div>
<div class="section" id="id50">
<h2>カバレッジ<a class="headerlink" href="#id50" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>%もみるが、何行目がパスしてないかを良く見る。</li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ coverage run --omit <span class="s1">&#39;manage.py&#39;</span>,<span class="s1">&#39;*/migrations/*&#39;</span> python manage.py <span class="nb">test</span>
$ coverage report -m
</pre></div>
</div>
<ul class="simple">
<li>分岐網羅まで計測したければ <code class="docutils literal notranslate"><span class="pre">--branch</span></code> オプションをつけて実行する</li>
</ul>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Name                          Stmts   Miss  Cover   Missing
-----------------------------------------------------------
account/__init__.py               1      0   100%
account/admin.py                145     22    85%   19, 24-26, 59, 63-64, 100, 104-105, 137, 141-142, 173, 177-178, 209, 213-214, 247, 251-252
account/apps.py                   9      0   100%
account/forms.py                 29      0   100%
account/models.py               239      0   100%
account/views.py                150      5    97%   59, 101, 199

〜 省略 〜
-----------------------------------------------------------
TOTAL                         28606   1240    96%
</pre></div>
</div>
</div>
<div class="section" id="id51">
<h2>設定ファイル<a class="headerlink" href="#id51" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>.coveragerc</li>
<li><a class="reference external" href="http://coverage.readthedocs.io/en/coverage-4.2/config.html#configuration-files">http://coverage.readthedocs.io/en/coverage-4.2/config.html#configuration-files</a></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">run</span><span class="p">]</span>
<span class="n">omit</span> <span class="o">=</span> <span class="o">*/</span><span class="n">migrations</span><span class="o">/*</span><span class="p">,</span><span class="n">manage</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
</div>
<div class="section" id="id52">
<h2>対象を絞ってテストする<a class="headerlink" href="#id52" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>どこかで使われていて、たまたまカバレッジが上がってるだけのケース</li>
<li>対象を絞ってテストすることで…</li>
</ul>
<blockquote>
<div><ul class="simple">
<li><strong>テストがない</strong> ところがわかる</li>
<li>素早くテストも終わる</li>
</ul>
</div></blockquote>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 特定のモジューブ</span>
$ python manage.py <span class="nb">test</span> spam.tests.test_models

<span class="c1"># 特定のテストクラス</span>
$ python manage.py <span class="nb">test</span> spam.tests.test_models.TestSpamClass

<span class="c1"># 特定のテストケース</span>
$ python manage.py <span class="nb">test</span> spam.tests.test_models.TestSpamClass.test_sham
</pre></div>
</div>
</div>
<div class="section" id="id53">
<h2>システム全体での カバレッジ 100% に固執しない<a class="headerlink" href="#id53" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>「カバレッジ100% = テストが書かれている」ことがわかるだけ</li>
<li>コードベースが巨大なほど、カバレッジをあげるのは大変になります。</li>
<li>コード・システムの質は設計の見直し/リファクタリングを繰り返し行うことであがります。</li>
</ul>
</div>
<div class="section" id="id54">
<h2>先人たちのお言葉<a class="headerlink" href="#id54" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>100％のテストカバレッジを誇りに思うということは、新聞のあらゆる言葉を読むことを誇りに思うようなものです。いくつかは他よりも重要です。(Kent beck)</li>
<li>カバレッジ解析の価値は何なんだろう？まずは、テストが不十分なコードを見つけるのに役立つ。カバレッジツールをしょっちゅう実行して、テストのないコードを見つけておくのは価値のあることだ。それらのコードがテストされていないことで不安になるだろうか？ (Martin Fowler)</li>
</ul>
</div>
<div class="section" id="id55">
<h2>雑多なネタ<a class="headerlink" href="#id55" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="view">
<h2>viewのテストどうしてる？<a class="headerlink" href="#view" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/testing/tools/#the-test-client">django.test.TestCase.client</a> を利用している。</li>
<li>ダミーのWebブラウザとして利用できる。</li>
<li>HTMLの中身まではあまりテストしない -&gt; HTMLが頻繁に変わると辛いから</li>
<li>複雑なロジックはviewの中にかかない -&gt; 外出してユニットテストを書く</li>
<li><code class="docutils literal notranslate"><span class="pre">request</span></code> オブジェクトを view 以外に持ち出さない -&gt; requsetから取り出したデータを渡す</li>
<li><code class="docutils literal notranslate"><span class="pre">TemplateResponse.context</span></code> はcontextの辞書をそのあまま持ってるのでテストしやすい -&gt; <code class="docutils literal notranslate"><span class="pre">render</span></code> はもってない</li>
<li>TestCase.clientを使う =&gt; <strong>機能テスト</strong></li>
</ul>
</div>
<div class="section" id="id56">
<h2>viewのテストどうしてる？<a class="headerlink" href="#id56" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestItemDetailView</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_getTarget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s1">&#39;item:detail&#39;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;pk&#39;</span><span class="p">:</span> <span class="n">pk</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">test_not_found</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getTarget</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">404</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_display_item</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="n">ItemFactory</span><span class="p">()</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_getTarget</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;item&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTemplateUsed</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="s1">&#39;item/detail.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="e">
<h2>Eメール送信のテストは<a class="headerlink" href="#e" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">manage.py</span> <span class="pre">test</span></code> では <strong>実際にメールは送信されない</strong></li>
<li>送信内容 <code class="docutils literal notranslate"><span class="pre">mail.outbox</span></code> から取得可能 + それをテストする</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.core</span> <span class="kn">import</span> <span class="n">mail</span>
<span class="kn">from</span> <span class="nn">django.test</span> <span class="kn">import</span> <span class="n">TestCase</span>

<span class="k">class</span> <span class="nc">TestEmail</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_send_email</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">mail</span><span class="o">.</span><span class="n">send_mail</span><span class="p">(</span><span class="s1">&#39;subject&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;body.&#39;</span><span class="p">,</span>
                   <span class="s1">&#39;from@example.com&#39;</span><span class="p">,</span>
                   <span class="p">[</span><span class="s1">&#39;to@example.com&#39;</span><span class="p">],</span> <span class="n">fail_silently</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">mail</span><span class="o">.</span><span class="n">outbox</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">subject</span><span class="p">,</span> <span class="s1">&#39;subject&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id57">
<h2>Django コマンドのテスト<a class="headerlink" href="#id57" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/django-admin/#django.core.management.call_command">django.core.management.call_command</a> でテストしている</li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">TestSpamCommand</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">_callCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">django.core.management</span> <span class="kn">import</span> <span class="n">call_command</span>
        <span class="k">return</span> <span class="n">call_command</span><span class="p">(</span><span class="s1">&#39;spam&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_spam_command</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="id58">
<h2>ログ/標準出力の確認<a class="headerlink" href="#id58" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>明確にチェックしたいデータがあるわけではない場合</li>
<li>ログや標準出力で書き出された内容を確認したい時がある</li>
<li>testfixturesに <a class="reference external" href="https://testfixtures.readthedocs.io/en/latest/logging.html">LogCapture</a> と <a class="reference external" href="https://testfixtures.readthedocs.io/en/latest/streams.html">OutputCapture</a> というのがあります。便利。</li>
</ul>
<div class="highlight-pycon notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">logging</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">testfixtures</span> <span class="kn">import</span> <span class="n">LogCapture</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">LogCapture</span><span class="p">()</span> <span class="k">as</span> <span class="n">l</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;a message&#39;</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;an error&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">l</span><span class="o">.</span><span class="n">check</span><span class="p">(</span>
<span class="gp">... </span>    <span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;INFO&#39;</span><span class="p">,</span> <span class="s1">&#39;a message&#39;</span><span class="p">),</span>
<span class="gp">... </span>    <span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">,</span> <span class="s1">&#39;an error&#39;</span><span class="p">),</span>
<span class="gp">... </span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="settings">
<h2>テスト用に一時的にsettingsの中身を変更したい<a class="headerlink" href="#settings" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>専用のユーティリティがある</li>
<li><a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/testing/tools/#django.test.override_settings">override_settings</a></li>
<li><a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/testing/tools/#django.test.modify_settings">modify_settings</a></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LoginTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@override_settings</span><span class="p">(</span><span class="n">LOGIN_URL</span><span class="o">=</span><span class="s1">&#39;/other/login/&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_login</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/sekrit/&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRedirects</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;/other/login/?next=/sekrit/&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MiddlewareTestCase</span><span class="p">(</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@modify_settings</span><span class="p">(</span><span class="n">MIDDLEWARE</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;append&#39;</span><span class="p">:</span> <span class="s1">&#39;django.middleware.cache.FetchFromCacheMiddleware&#39;</span><span class="p">,</span>
        <span class="s1">&#39;prepend&#39;</span><span class="p">:</span> <span class="s1">&#39;django.middleware.cache.UpdateCacheMiddleware&#39;</span><span class="p">,</span>
    <span class="p">})</span>
    <span class="k">def</span> <span class="nf">test_cache_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="celery">
<h2>ジョブキュー(Celery)のユニットテスト<a class="headerlink" href="#celery" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>非同期でジョブが動く</li>
<li>ちゃんと動かすには celeryデーモンが必要</li>
</ul>
<p>どうすれば良いのか？</p>
<ul class="simple">
<li>同期的に実行するオプションがある</li>
<li><code class="docutils literal notranslate"><span class="pre">CELERY_ALWAYS_EAGER</span> <span class="pre">=</span> <span class="pre">True</span></code></li>
<li>関数としてそのままジョブの中身が実行される</li>
<li>celeryデーモンも不要</li>
<li><a class="reference external" href="http://docs.celeryproject.org/en/3.1/configuration.html#std:setting-CELERY_ALWAYS_EAGER">http://docs.celeryproject.org/en/3.1/configuration.html#std:setting-CELERY_ALWAYS_EAGER</a></li>
</ul>
</div>
<div class="section" id="tox">
<h2>tox<a class="headerlink" href="#tox" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://tox.readthedocs.io/en/latest/">https://tox.readthedocs.io/en/latest/</a></li>
<li>Pythonライブラリを複数バージョンでテストするツールです。</li>
<li>パッケージングしなくても魅力的。</li>
<li>専用のvirtualenvを作ってくれる。</li>
<li>静的解析ツール(flake8, mypy)と併せて利用できる。</li>
</ul>
</div>
<div class="section" id="id59">
<h2>tox の 設定<a class="headerlink" href="#id59" title="Permalink to this headline">¶</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">tox</span><span class="p">]</span>
<span class="n">envlist</span> <span class="o">=</span> <span class="n">py36</span><span class="p">,</span> <span class="n">flake8</span>
<span class="n">skipsdist</span> <span class="o">=</span> <span class="n">true</span>

<span class="p">[</span><span class="n">testenv</span><span class="p">]</span>
<span class="n">deps</span> <span class="o">=</span> <span class="o">-</span><span class="n">r</span><span class="p">{</span><span class="n">toxinidir</span><span class="p">}</span><span class="o">/</span><span class="n">dev</span><span class="o">-</span><span class="n">requires</span><span class="o">.</span><span class="n">txt</span>

<span class="n">setenv</span> <span class="o">=</span>
  <span class="n">DJANGO_SETTINGS_MODULE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">test</span>

<span class="n">changedir</span> <span class="o">=</span> <span class="p">{</span><span class="n">toxinidir</span><span class="p">}</span><span class="o">/</span><span class="n">src</span>
<span class="n">commands</span> <span class="o">=</span> <span class="n">coverage</span> <span class="n">run</span> <span class="o">--</span><span class="n">omit</span> <span class="s2">&quot;manage.py&quot;</span><span class="p">,</span><span class="s2">&quot;*/migrations/\*&quot;</span> <span class="n">python</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span> <span class="n">test</span> <span class="p">{</span><span class="n">posargs</span><span class="p">}</span>

<span class="p">[</span><span class="n">testenv</span><span class="p">:</span><span class="n">flake8</span><span class="p">]</span>
<span class="n">deps</span> <span class="o">=</span>
  <span class="n">flake8</span>
  <span class="n">mccabe</span>

<span class="n">commands</span> <span class="o">=</span> <span class="n">flake8</span> <span class="o">.</span>

<span class="p">[</span><span class="n">flake8</span><span class="p">]</span>
<span class="n">exclude</span> <span class="o">=</span> <span class="n">tests</span><span class="o">/</span>\<span class="o">*</span><span class="p">,</span> \<span class="o">*/</span><span class="n">migrations</span><span class="o">/</span>\<span class="o">*</span><span class="p">,</span> <span class="n">urls</span><span class="o">.</span><span class="n">py</span><span class="p">,</span> <span class="n">manage</span><span class="o">.</span><span class="n">py</span>
<span class="nb">max</span><span class="o">-</span><span class="n">line</span><span class="o">-</span><span class="n">length</span> <span class="o">=</span> <span class="mi">100</span>
</pre></div>
</div>
</div>
<div class="section" id="id60">
<h2>tox の 実行<a class="headerlink" href="#id60" title="Permalink to this headline">¶</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ tox <span class="c1"># 全ての testenv が実行される</span>
$ tox -e flake8 <span class="c1"># flake8のtestenvだけ実行される</span>
</pre></div>
</div>
</div>
<div class="section" id="id61">
<h2>テストの高速化<a class="headerlink" href="#id61" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>(特にローカルでは) テストを頻繁に実行するので、可能な限り早くなってほしい。</li>
<li><a class="reference external" href="http://y0m0r.hateblo.jp/entry/20130615/1371305730">Djangoでテストを速くするためにいろいろやってみた</a></li>
</ul>
<p>トピック</p>
<ul class="simple">
<li>django.test.TestCase -&gt; unittest.TestCaseへの変更</li>
<li>sqlite3 の in-meory DBを使う</li>
<li>migrations を OFFにする</li>
<li>PASSWORD_HASHERSの変更</li>
</ul>
<hr class="docutils" />
<ul class="simple">
<li>setupTestDataの利用検討</li>
<li>python manage.py test の –parallel オプションを使う</li>
</ul>
</div>
<div class="section" id="id63">
<h2>まとめ<a class="headerlink" href="#id63" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>後から不安なく、設計を見直したり/リファクタリングできるようにテストを書こう</li>
<li>まずはシンプルで必要十分なテストを書くところから始めよう</li>
<li>フィクスチャーやモックのツールを使おう</li>
<li>先人達の知恵を有効活用しよう</li>
</ul>
</div>
<div class="section" id="python-3">
<h2>Pythonプロフェショナルプログラミング 第3版<a class="headerlink" href="#python-3" title="Permalink to this headline">¶</a></h2>
<p>来月くらいに第3版がでます！よろしくお願いします！(予定)</p>
<div class="figure">
<a class="reference internal image-reference" href="https://images-na.ssl-images-amazon.com/images/I/41jP7BdvluL._SX385_BO1,204,203,200_.jpg"><img alt="https://images-na.ssl-images-amazon.com/images/I/41jP7BdvluL._SX385_BO1,204,203,200_.jpg" src="https://images-na.ssl-images-amazon.com/images/I/41jP7BdvluL._SX385_BO1,204,203,200_.jpg" style="width: 40%;" /></a>
</div>
</div>
<div class="section" id="kent-beck">
<h2>Kent Beck のお言葉<a class="headerlink" href="#kent-beck" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Tests are the Programmer’s Stone, transmuting fear into boredom</li>
<li>テストはプログラマーの石(?)、恐れを退屈に変えてくれます。</li>
<li><strong>不安が退屈に変わるまでテストしよう</strong></li>
</ul>
</div>
<div class="section" id="id64">
<h2>参考<a class="headerlink" href="#id64" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><a class="reference external" href="https://github.com/tell-k/djangocongressjp2018/blob/master/reference.rst">https://github.com/tell-k/djangocongressjp2018/blob/master/reference.rst</a></li>
<li>Webページ や 書籍 の著者の皆さん 本当に ありがとうございます。m(_ _)m</li>
</ul>
</div>
<div class="section" id="id65">
<h2>ご静聴ありがとうございました<a class="headerlink" href="#id65" title="Permalink to this headline">¶</a></h2>
</div>
</div>


  </body>
  <div id="help">
      Use the left and right arrow keys or click the left and right
      edges of the page to navigate between slides.<br>
      (Press 'H' or navigate to hide this message.)
  </div>
  <script type="text/javascript" src="_static/js/init.js"></script>
  <script type="text/javascript" src="_static/js/notes.js"></script>
  <script type="text/javascript" src="_static/js/slides.js"></script>
</html>